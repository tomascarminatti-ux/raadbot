<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raadbot Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gem-card { transition: all 0.3s ease; }
        .gem-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        .active-gem { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 glass border-r flex flex-col">
        <div class="p-6 border-b border-white/10">
            <h1 class="text-xl font-bold flex items-center gap-2 text-blue-400">
                <span>ü§ñ</span> RAADBOT 2.0
            </h1>
            <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest font-semibold">Industrial Orchestrator</p>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto" id="gem-nav">
            <!-- GEMS will be loaded here -->
            <div class="animate-pulse space-y-2">
                <div class="h-10 bg-slate-800 rounded"></div>
                <div class="h-10 bg-slate-800 rounded"></div>
                <div class="h-10 bg-slate-800 rounded"></div>
            </div>
        </nav>
        <div class="p-4 border-t border-white/10 text-xs text-slate-500">
            v2.0.0 Production Ready
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 glass flex items-center justify-between px-8 border-b">
            <h2 id="current-gem-title" class="text-lg font-semibold">Selecciona un M√≥dulo GEM</h2>
            <div class="flex items-center gap-4">
                <span id="system-status" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-bold border border-green-500/30">ONLINE</span>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Prompt Viewer -->
            <section class="flex-1 p-8 overflow-y-auto space-y-6">
                <div class="glass p-6 rounded-xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">System Prompt</h3>
                        <div class="flex items-center gap-3">
                            <button id="copy-btn" onclick="copyToClipboard()" class="hidden text-xs text-slate-400 hover:text-white transition-colors flex items-center gap-1" aria-label="Copiar prompt al portapapeles">
                                <span id="copy-icon">üìã</span> <span id="copy-text">Copiar</span>
                            </button>
                            <span class="text-xs text-blue-400 px-2 py-1 bg-blue-400/10 rounded">Read-only</span>
                        </div>
                    </div>
                    <pre id="prompt-content" class="text-xs text-slate-300 whitespace-pre-wrap leading-relaxed bg-black/30 p-4 rounded-lg border border-white/5 font-mono max-h-[60vh] overflow-y-auto">Selecciona un GEM para ver sus instrucciones core...</pre>
                </div>
            </section>

            <!-- Chat & Controls -->
            <section class="w-96 glass border-l p-6 flex flex-col space-y-6">
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Refinamiento IA</h3>
                    <p class="text-xs text-slate-500">Dale instrucciones al orquestador para ajustar el comportamiento de este GEM.</p>
                </div>

                <div class="flex-1 bg-black/20 rounded-xl p-4 border border-white/5 overflow-y-auto" id="chat-history">
                    <div class="text-xs text-slate-500 italic">Chat disponible al seleccionar un GEM...</div>
                </div>

                <div class="space-y-3">
                    <textarea id="refine-input" aria-label="Instrucciones para refinar el GEM" rows="3" class="w-full bg-slate-800 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition-all placeholder:text-slate-600" placeholder="Ej: Hazlo m√°s estricto verificando las fechas del CV..."></textarea>
                    <button onclick="refineGem()" id="send-btn" disabled class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white font-semibold py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <span>üöÄ</span> Refinar Prompt
                    </button>
                </div>
            </section>
        </div>
    </main>

    <div id="live-logs" style="position:fixed; bottom:20px; right:20px; width:400px; height:300px; background:#000; color:#0f0; padding:10px; font-family:monospace; font-size:12px; overflow-y:auto; border:2px solid #0f0; border-radius:10px; z-index:1000; opacity:0.9;">
        <div style="border-bottom:1px solid #0f0; padding-bottom:5px; margin-bottom:10px; font-weight:bold;">üöÄ Raadbot Live - GEMs en tiempo real</div>
        <div id="logs-container"></div>
    </div>
    <script>
        const logsContainer = document.getElementById('logs-container');
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${protocol}//${window.location.host}/ws/logs`);
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            const time = data.timestamp ? data.timestamp.split('T')[1].split('.')[0] : '--:--:--';
            logEntry.innerHTML = `[${time}] <span style="color:#3b82f6">${data.gem}</span>: ${data.action} - <span style="color:${data.status === 'OK' ? '#4ade80' : '#f87171'}">${data.status}</span> (Score: ${data.score || 'N/A'})`;
            logsContainer.prepend(logEntry);
        };

        let gems = [];
        let activeGem = null;
        let copyTimeout;

        function copyToClipboard() {
            const text = document.getElementById('prompt-content').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copy-btn');
                const textEl = document.getElementById('copy-text');
                const iconEl = document.getElementById('copy-icon');

                const oldText = textEl.innerText;
                const oldIcon = iconEl.innerText;

                textEl.innerText = 'Copiado!';
                iconEl.innerText = '‚úÖ';
                btn.classList.add('text-green-400');

                if (copyTimeout) clearTimeout(copyTimeout);
                copyTimeout = setTimeout(() => {
                    textEl.innerText = oldText;
                    iconEl.innerText = oldIcon;
                    btn.classList.remove('text-green-400');
                }, 2000);
            });
        }

        async function loadGems() {
            try {
                const res = await fetch('/api/v1/gems');
                gems = await res.json();
                renderNav();
            } catch (err) {
                console.error("Error loading gems:", err);
            }
        }

        function renderNav() {
            const nav = document.getElementById('gem-nav');
            nav.innerHTML = gems.map(gem => `
                <button onclick="selectGem('${gem.id}')" id="btn-${gem.id}" class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all hover:bg-white/5 flex items-center justify-between group">
                    <span>${gem.name}</span>
                    <span class="opacity-0 group-hover:opacity-100 transition-opacity text-blue-400">‚ûî</span>
                </button>
            `).join('');
        }

        function selectGem(id) {
            activeGem = gems.find(g => g.id === id);
            
            // UI Updates
            document.querySelectorAll('#gem-nav button').forEach(b => b.classList.remove('active-gem', 'text-blue-400'));
            document.getElementById(`btn-${id}`).classList.add('active-gem', 'text-blue-400');
            
            document.getElementById('current-gem-title').innerText = `${activeGem.name} - ${id}`;
            document.getElementById('prompt-content').innerText = activeGem.prompt;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('copy-btn').classList.remove('hidden');
            
            document.getElementById('chat-history').innerHTML = `
                <div class="bg-blue-600/10 border border-blue-500/30 p-3 rounded-lg text-xs leading-relaxed text-blue-200">
                    <strong>Soporte de Agente:</strong> Estoy listo para ayudarte a refinar las instrucciones de <strong>${activeGem.name}</strong>. ¬øQu√© cambio te gustar√≠a implementar?
                </div>
            `;
        }

        async function refineGem() {
            const input = document.getElementById('refine-input');
            const instruction = input.value.trim();
            if (!instruction || !activeGem) return;

            const btn = document.getElementById('send-btn');
            const history = document.getElementById('chat-history');
            
            // Add user message
            history.innerHTML += `
                <div class="mt-4 text-right">
                    <span class="inline-block bg-slate-700 p-2 rounded-lg text-xs text-white">${instruction}</span>
                </div>
            `;
            
            input.value = '';
            btn.disabled = true;
            btn.innerHTML = '<span>‚ö°</span> Procesando...';

            try {
                const res = await fetch('/api/v1/gems/refine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gem_id: activeGem.id, instruction })
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    history.innerHTML += `
                        <div class="mt-4 bg-green-600/10 border border-green-500/30 p-3 rounded-lg text-xs text-green-200">
                            <strong>‚úÖ Prompt Refinado:</strong> Las instrucciones han sido actualizadas y guardadas en el sistema.
                        </div>
                    `;
                    document.getElementById('prompt-content').innerText = data.new_prompt;
                    // Update local data
                    activeGem.prompt = data.new_prompt;
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                history.innerHTML += `
                    <div class="mt-4 bg-red-600/10 border border-red-500/30 p-3 rounded-lg text-xs text-red-200">
                        <strong>‚ùå Error:</strong> No pude procesar el refinamiento. Intenta de nuevo.
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üöÄ</span> Refinar Prompt';
                history.scrollTop = history.scrollHeight;
            }
        }

        // Init
        loadGems();
    </script>
</body>
</html>
